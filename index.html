<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — Painel de Registros</title>
<style>
  body{font-family:Inter,system-ui,Arial;background:#0f1724;color:#e6eef8;margin:0;padding:18px}
  .wrap{max-width:1100px;margin:0 auto}
  .card{background:linear-gradient(180deg,#071124,#071a2c);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  input,button,select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
  button{cursor:pointer;background:#1f6feb;border:0;color:#fff;padding:8px 10px}
  .danger{background:#8b2c2c}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px;text-align:left}
  .muted{color:#98a0b3}
  .small{font-size:13px;color:#98a0b3}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .hidden{display:none}
  .top{display:flex;justify-content:space-between;align-items:center;gap:12px}
  @media(max-width:900px){ .top{flex-direction:column;align-items:flex-start} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="loginCard">
      <h2>Admin — Acesso</h2>
      <p class="small muted">Página de visualização dos registros (teste). Protegida por senha simples.</p>
      <label>Senha do admin</label>
      <input id="adminPass" type="password" placeholder="Senha do administrador">
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px">
        <button id="btnLogin">Entrar</button>
        <button id="btnLogout" class="hidden">Sair</button>
        <button id="btnOpenForm">Abrir Formulário</button>
      </div>
      <div id="loginMsg" class="small" style="margin-top:8px"></div>
    </div>

    <div class="card hidden" id="dashboard">
      <div class="top">
        <div>
          <h2 style="margin:0">Painel de Registros</h2>
          <div class="small muted">Veja, busque, exporte e remova registros.</div>
        </div>

        <div class="controls">
          <input id="search" placeholder="Buscar por nome ou email" style="min-width:220px;padding:8px;border-radius:8px">
          <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="maskCPF" checked> Mascarar CPF</label>
          <button id="btnExport">Exportar CSV</button>
          <button id="btnClearAll" class="danger">Apagar tudo</button>
        </div>
      </div>

      <div style="overflow:auto;margin-top:12px">
        <table id="tbl">
          <thead>
            <tr><th>Nome</th><th>Email</th><th>Senha</th><th>CPF</th><th>Criado em</th><th>Ação</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="small muted" style="margin-top:10px">Senha de admin padrão: <code>admin123</code>. Troque no arquivo se precisar.</div>
    </div>
  </div>

<script>
const STORAGE_KEY = 'test_users_serverless_demo'
const ADMIN_PASS = 'admin123' // trocar se quiser

const loginCard = document.getElementById('loginCard')
const adminPass = document.getElementById('adminPass')
const btnLogin = document.getElementById('btnLogin')
const btnLogout = document.getElementById('btnLogout')
const btnOpenForm = document.getElementById('btnOpenForm')
const loginMsg = document.getElementById('loginMsg')

const dashboard = document.getElementById('dashboard')
const tblBody = document.querySelector('#tbl tbody')
const searchInp = document.getElementById('search')
const maskCPFcb = document.getElementById('maskCPF')
const btnExport = document.getElementById('btnExport')
const btnClearAll = document.getElementById('btnClearAll')

const SESSION_KEY = 'admin_logged_v1'

function loadUsers(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]') }catch(e){ return [] } }
function saveUsers(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)) }
function formatDate(iso){ try{ return new Date(iso).toLocaleString() }catch(e){ return iso } }
function onlyDigits(s){ return String(s||'').replace(/\D/g,'') }
function maskCPF(s){
  s = onlyDigits(s||'')
  if(s.length<3) return s
  const last2 = s.slice(-2)
  return '***.***.***-'+last2
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

function renderTable(filter=''){
  const q = (filter||'').toLowerCase()
  const users = loadUsers()
  tblBody.innerHTML = ''
  users.filter(u => !q || (u.name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q))
       .forEach((u, idx)=>{
    const tr = document.createElement('tr')
    const cpf = maskCPFcb.checked ? maskCPF(u.cpf) : u.cpf
    tr.innerHTML = `
      <td>${escapeHtml(u.name||'—')}</td>
      <td>${escapeHtml(u.email||'—')}</td>
      <td style="font-family:monospace">${escapeHtml(u.password||'—')}</td>
      <td style="font-family:monospace">${escapeHtml(cpf||'—')}</td>
      <td>${escapeHtml(formatDate(u.createdAt))}</td>
      <td><button data-idx="${idx}">Remover</button></td>
    `
    tblBody.appendChild(tr)
  })
  Array.from(tblBody.querySelectorAll('button[data-idx]')).forEach(b=>{
    b.addEventListener('click', ()=>{
      if(!confirm('Remover este registro?')) return
      const idx = Number(b.dataset.idx)
      const users = loadUsers()
      users.splice(idx, 1)
      saveUsers(users)
      renderTable(searchInp.value)
    })
  })
}

function setLogged(flag){ if(flag) sessionStorage.setItem(SESSION_KEY,'1'); else sessionStorage.removeItem(SESSION_KEY); updateUI() }
function isLogged(){ return sessionStorage.getItem(SESSION_KEY) === '1' }

function updateUI(){
  if(isLogged()){
    loginCard.classList.add('hidden')
    dashboard.classList.remove('hidden')
    btnLogout.classList.remove('hidden')
    renderTable()
  } else {
    loginCard.classList.remove('hidden')
    dashboard.classList.add('hidden')
    btnLogout.classList.add('hidden')
  }
}

btnLogin.addEventListener('click', ()=>{
  if(adminPass.value === ADMIN_PASS){
    setLogged(true)
    adminPass.value = ''
    loginMsg.textContent = ''
  } else loginMsg.textContent = 'Senha incorreta.'
})

btnLogout.addEventListener('click', ()=> setLogged(false))

// **ABRIR FORMULÁRIO NA MESMA ABA**
btnOpenForm.addEventListener('click', ()=>{
  window.location.href = 'index.html'
})

searchInp.addEventListener('input', ()=> renderTable(searchInp.value))
maskCPFcb.addEventListener('change', ()=> renderTable(searchInp.value))

btnExport.addEventListener('click', ()=>{
  const users = loadUsers()
  if(!users.length) return alert('Sem registros para exportar.')
  const rows = [['id','name','email','password','cpf','createdAt']]
  users.forEach(u=>rows.push([u.id||'',u.name||'',u.email||'',u.password||'',u.cpf||'',u.createdAt||'']))
  const csv = rows.map(r=>r.map(c=>'\"'+String(c||'').replace(/\"/g,'\"\"')+'\"').join(',')).join('\n')
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'})
  const url = URL.createObjectURL(blob)
  const a=document.createElement('a'); a.href=url; a.download='usuarios_admin.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
})

btnClearAll.addEventListener('click', ()=>{
  if(!confirm('Apagar TODOS os registros?')) return
  saveUsers([]); renderTable()
})

updateUI()
</script>
</body>
</html>
